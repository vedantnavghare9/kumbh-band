<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Kumbh Band Prototype</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body {
  background: radial-gradient(circle at top, #0f172a, #020617);
  color: #e5e7eb;
  font-family: system-ui, -apple-system, sans-serif;
  text-align: center;
  padding: 20px;
  min-height: 100vh;
}

.container {
  max-width: 500px;
  margin: 0 auto;
}

h2 {
  font-weight: 700;
  font-size: 2rem;
  margin-bottom: 10px;
  color: #60a5fa;
  text-shadow: 0 2px 4px rgba(0,0,0,0.5);
}

.subtitle {
  color: #94a3b8;
  margin-bottom: 30px;
  font-size: 0.9rem;
}

.circle {
  width: 220px;
  height: 220px;
  border-radius: 50%;
  border: 12px solid #64748b;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  margin: 20px auto;
  transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  position: relative;
  overflow: hidden;
}

.circle::after {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(96, 165, 250, 0.1) 0%, transparent 70%);
  opacity: 0;
  transition: opacity 0.5s;
}

.circle.safe-circle::after {
  background: radial-gradient(circle, rgba(34, 197, 94, 0.1) 0%, transparent 70%);
  opacity: 0.5;
}

.circle.danger-circle::after {
  background: radial-gradient(circle, rgba(239, 68, 68, 0.1) 0%, transparent 70%);
  opacity: 0.5;
}

.distance {
  font-size: 48px;
  font-weight: 700;
  color: #ffffff;
  transition: all 0.3s ease;
}

.distance.changing {
  transform: scale(1.1);
  color: #fbbf24;
}

.unit {
  font-size: 20px;
  color: #94a3b8;
  margin-top: 5px;
}

#status {
  font-size: 16px;
  letter-spacing: 1px;
  margin: 15px 0;
  padding: 8px 16px;
  border-radius: 20px;
  background: rgba(30, 41, 59, 0.5);
  display: inline-block;
}

.arrow-container {
  font-size: 60px;
  margin: 15px 0;
  height: 70px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.arrow {
  transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
}

.kid-section {
  background: rgba(30, 41, 59, 0.7);
  padding: 20px;
  border-radius: 16px;
  margin: 25px 0;
}

.kid-label {
  font-size: 14px;
  color: #94a3b8;
  margin-bottom: 8px;
  letter-spacing: 1px;
}

.kid-box {
  font-size: 32px;
  font-weight: 800;
  color: #22c55e;
  letter-spacing: 3px;
  font-family: monospace;
  text-shadow: 0 0 10px rgba(34, 197, 94, 0.3);
  padding: 10px;
  border: 2px solid #334155;
  border-radius: 10px;
  background: rgba(15, 23, 42, 0.8);
}

.input-section {
  background: rgba(30, 41, 59, 0.7);
  padding: 20px;
  border-radius: 16px;
  margin: 20px 0;
}

.input-label {
  font-size: 14px;
  color: #94a3b8;
  margin-bottom: 10px;
  display: block;
}

input {
  padding: 14px;
  border-radius: 12px;
  border: 2px solid #475569;
  width: 90%;
  max-width: 300px;
  background: #0f172a;
  color: #ffffff;
  font-size: 16px;
  text-align: center;
  transition: border-color 0.3s;
}

input:focus {
  outline: none;
  border-color: #60a5fa;
}

.range-section {
  background: rgba(30, 41, 59, 0.7);
  padding: 20px;
  border-radius: 16px;
  margin: 20px 0;
}

.range-label {
  font-size: 14px;
  color: #94a3b8;
  margin-bottom: 15px;
}

.range-value {
  font-size: 24px;
  font-weight: 700;
  color: #22c55e;
  margin: 10px 0;
}

.range-controls {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-top: 15px;
}

.range-btn {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  border: none;
  background: #475569;
  color: white;
  font-size: 24px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s;
}

.range-btn:hover {
  background: #64748b;
  transform: scale(1.1);
}

.button-section {
  margin: 30px 0;
  display: flex;
  flex-direction: column;
  gap: 15px;
  align-items: center;
}

button {
  padding: 16px 32px;
  border-radius: 25px;
  border: none;
  font-size: 18px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  letter-spacing: 1px;
}

#connectBtn {
  background: linear-gradient(135deg, #22c55e, #16a34a);
  color: white;
  box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
  width: 90%;
  max-width: 300px;
}

#connectBtn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
}

#connectBtn.disconnect {
  background: linear-gradient(135deg, #ef4444, #dc2626);
  box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
}

#connectBtn.disconnect:hover {
  box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
}

.simulation-controls {
  background: rgba(30, 41, 59, 0.7);
  padding: 20px;
  border-radius: 16px;
  margin: 20px 0;
}

.simulation-label {
  font-size: 14px;
  color: #94a3b8;
  margin-bottom: 15px;
}

.sim-btn {
  background: linear-gradient(135deg, #8b5cf6, #7c3aed);
  color: white;
  margin: 5px;
  padding: 12px 24px;
  min-width: 120px;
}

.sim-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
}

.sim-btn-group {
  display: flex;
  justify-content: center;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 10px;
}

.instructions {
  font-size: 12px;
  color: #64748b;
  margin-top: 30px;
  padding: 15px;
  border-top: 1px solid #334155;
  line-height: 1.5;
}

.status-indicator {
  display: inline-block;
  width: 10px;
  height: 10px;
  border-radius: 50%;
  margin-right: 8px;
  background: #ef4444;
}

.status-indicator.connected {
  background: #22c55e;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.5; }
  100% { opacity: 1; }
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
}

.danger-circle {
  animation: pulse 1s infinite, shake 0.5s ease-in-out;
}

.warning-circle {
  animation: pulse 2s infinite;
}

@media (max-width: 480px) {
  .circle {
    width: 200px;
    height: 200px;
  }
  
  .distance {
    font-size: 40px;
  }
  
  .kid-box {
    font-size: 28px;
  }
  
  .sim-btn-group {
    flex-direction: column;
    align-items: center;
  }
  
  .sim-btn {
    width: 90%;
    max-width: 200px;
  }
}
</style>
</head>

<body>

<div class="container">
  <h2>KUMBH BAND</h2>
  <div class="subtitle">Prevent separation before it happens</div>

  <!-- Distance Circle -->
  <div class="circle" id="circle">
    <div class="distance" id="distance">--</div>
    <div class="unit">meters</div>
  </div>

  <!-- Status Indicator -->
  <div id="status">
    <span class="status-indicator" id="statusIndicator"></span>
    <span id="statusText">Not connected</span>
  </div>

  <!-- Direction Arrow -->
  <div class="arrow-container">
    <div class="arrow" id="arrow">⬆️</div>
  </div>

  <!-- Your K-ID Section -->
  <div class="kid-section">
    <div class="kid-label">YOUR K-ID</div>
    <div class="kid-box" id="myId">K-0000</div>
  </div>

  <!-- Friend Input Section -->
  <div class="input-section">
    <label class="input-label" for="pairInput">ENTER FRIEND'S K-ID</label>
    <input type="text" id="pairInput" placeholder="Enter K-ID (e.g., K-1234)" />
  </div>

  <!-- Safe Range Controls -->
  <div class="range-section">
    <div class="range-label">SAFE DISTANCE RANGE</div>
    <div class="range-value" id="safeValue">50</div>
    <div>meters</div>
    <div class="range-controls">
      <button class="range-btn" onclick="changeRange(-10)">−</button>
      <button class="range-btn" onclick="changeRange(10)">+</button>
    </div>
  </div>

  <!-- Simulation Controls -->
  <div class="simulation-controls">
    <div class="simulation-label">TEST MOVEMENT SIMULATION</div>
    <div class="sim-btn-group">
      <button class="sim-btn" onclick="simulateDistance(10)">Move Closer (-10m)</button>
      <button class="sim-btn" onclick="simulateDistance(-10)">Move Away (+10m)</button>
    </div>
    <div class="sim-btn-group">
      <button class="sim-btn" onclick="simulateDistance(30)">Move Closer (-30m)</button>
      <button class="sim-btn" onclick="simulateDistance(-30)">Move Away (+30m)</button>
    </div>
    <div style="margin-top: 10px; font-size: 12px; color: #94a3b8;">
      Current simulated position: <span id="simPosition">0m</span>
    </div>
  </div>

  <!-- Connect/Disconnect Button -->
  <div class="button-section">
    <button id="connectBtn" onclick="toggleConnection()">CONNECT BAND</button>
  </div>

  <div class="instructions">
    <strong>How it works:</strong> 
    1. Enter your friend's K-ID and press CONNECT<br>
    2. Use simulation buttons to test distance changes<br>
    3. Circle changes color: Green = Safe, Yellow = Warning, Red = Danger<br>
    4. Arrow points toward your friend<br>
    5. Adjust safe range as needed
  </div>
</div>

<script type="module">
// ================= FIREBASE CONFIGURATION =================
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDVV1zZZDAnqOkmNXKW0ipJXatUYtjV4W4",
  authDomain: "kumbh-band-dd624.firebaseapp.com",
  projectId: "kumbh-band-dd624",
  storageBucket: "kumbh-band-dd624.appspot.com",
  messagingSenderId: "153944613096",
  appId: "1:153944613096:web:0c5fe544c93803c2c01902"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ================= GLOBAL STATE =================
let safeRange = 50;
let isConnected = false;
let geoWatchId = null;
let unsubscribeSnapshot = null;
let myId = null;
let friendId = null;
let distanceHistory = [];
let simulatedBaseDistance = 0; // Base distance offset for simulation
let currentDistance = 0;
let simulationMode = false; // Whether we're in simulation mode

// ================= DOM ELEMENTS =================
const elements = {
  distance: document.getElementById('distance'),
  circle: document.getElementById('circle'),
  statusText: document.getElementById('statusText'),
  statusIndicator: document.getElementById('statusIndicator'),
  arrow: document.getElementById('arrow'),
  myId: document.getElementById('myId'),
  pairInput: document.getElementById('pairInput'),
  safeValue: document.getElementById('safeValue'),
  connectBtn: document.getElementById('connectBtn'),
  simPosition: document.getElementById('simPosition')
};

// ================= INITIALIZATION =================
function initializeAppState() {
  // Load or generate K-ID
  myId = localStorage.getItem('kumbhBandKid');
  if (!myId) {
    myId = 'K-' + Math.floor(1000 + Math.random() * 9000);
    localStorage.setItem('kumbhBandKid', myId);
  }
  
  // Display K-ID
  elements.myId.textContent = myId;
  
  // Load saved safe range
  const savedRange = localStorage.getItem('kumbhBandSafeRange');
  if (savedRange) {
    safeRange = parseInt(savedRange);
    elements.safeValue.textContent = safeRange;
  }
  
  updateUI();
}

// ================= RANGE CONTROL =================
window.changeRange = function(change) {
  safeRange = Math.max(10, Math.min(100, safeRange + change));
  elements.safeValue.textContent = safeRange;
  localStorage.setItem('kumbhBandSafeRange', safeRange.toString());
  updateDistanceUI(currentDistance);
};

// ================= SIMULATION CONTROL =================
window.simulateDistance = function(change) {
  if (!isConnected) {
    alert('Please connect first to simulate movement');
    return;
  }
  
  // Add to simulated base distance
  simulatedBaseDistance += change;
  
  // Ensure simulated distance doesn't go below 0
  if (simulatedBaseDistance < 0) simulatedBaseDistance = 0;
  
  // Update simulation display
  elements.simPosition.textContent = `${simulatedBaseDistance}m`;
  
  // If we're in simulation mode, update the distance display
  if (simulationMode) {
    const newDistance = Math.max(1, currentDistance + change);
    currentDistance = newDistance;
    updateDistanceUI(newDistance);
    
    // Add visual feedback
    elements.distance.classList.add('changing');
    setTimeout(() => {
      elements.distance.classList.remove('changing');
    }, 300);
  } else {
    // If not in simulation mode but we have a real connection,
    // simulate by modifying the stored location
    simulateGeolocationMove(change);
  }
};

// ================= SIMULATE GEOLOCATION MOVEMENT =================
function simulateGeolocationMove(change) {
  // This function simulates movement by adjusting the stored geolocation
  if (!geoWatchId || !simulationMode) return;
  
  // Get current position
  navigator.geolocation.getCurrentPosition((position) => {
    // Calculate new position (simplified - moving in random direction)
    const latChange = (change / 111320) * (Math.random() > 0.5 ? 1 : -1);
    const lngChange = (change / 111320) * (Math.random() > 0.5 ? 1 : -1) / Math.cos(position.coords.latitude * Math.PI / 180);
    
    const newLat = position.coords.latitude + latChange;
    const newLng = position.coords.longitude + lngChange;
    
    // Update Firebase with simulated position
    const pairId = [myId, friendId].sort().join('_');
    const myLocationRef = doc(db, 'bands', pairId);
    
    setDoc(myLocationRef, {
      [myId]: {
        lat: newLat,
        lng: newLng,
        timestamp: Date.now(),
        simulated: true // Mark as simulated
      }
    }, { merge: true });
    
  }, null, { enableHighAccuracy: true });
}

// ================= DISTANCE CALCULATION =================
function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3; // Earth's radius in meters
  const φ1 = lat1 * Math.PI / 180;
  const φ2 = lat2 * Math.PI / 180;
  const Δφ = (lat2 - lat1) * Math.PI / 180;
  const Δλ = (lon2 - lon1) * Math.PI / 180;

  const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
            Math.cos(φ1) * Math.cos(φ2) *
            Math.sin(Δλ/2) * Math.sin(Δλ/2);
  
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  const rawDistance = R * c;
  
  // Add simulated base distance if in simulation mode
  return simulationMode ? Math.max(1, rawDistance + simulatedBaseDistance) : rawDistance;
}

// ================= DISTANCE SMOOTHING =================
function smoothDistance(distance) {
  distanceHistory.push(distance);
  if (distanceHistory.length > 5) {
    distanceHistory.shift();
  }
  
  const sum = distanceHistory.reduce((a, b) => a + b, 0);
  const average = Math.round(sum / distanceHistory.length);
  
  return average;
}

// ================= UI UPDATE FUNCTIONS =================
function updateUI() {
  // Update status indicator
  if (isConnected) {
    elements.statusIndicator.className = 'status-indicator connected';
    elements.statusText.textContent = simulationMode ? 'Connected (Simulation)' : 'Connected';
    elements.statusText.style.color = '#22c55e';
    elements.connectBtn.textContent = 'DISCONNECT BAND';
    elements.connectBtn.classList.add('disconnect');
  } else {
    elements.statusIndicator.className = 'status-indicator';
    elements.statusText.textContent = 'Not connected';
    elements.statusText.style.color = '#e5e7eb';
    elements.connectBtn.textContent = 'CONNECT BAND';
    elements.connectBtn.classList.remove('disconnect');
  }
}

function updateDistanceUI(distance) {
  if (distance === null || isNaN(distance)) {
    elements.distance.textContent = '--';
    elements.circle.className = 'circle';
    currentDistance = 0;
    return;
  }

  currentDistance = distance;
  
  // Update distance display with animation
  elements.distance.textContent = distance;
  elements.distance.style.transform = 'scale(1.1)';
  setTimeout(() => {
    elements.distance.style.transform = 'scale(1)';
  }, 200);
  
  // Update circle color based on safety
  elements.circle.className = 'circle';
  if (distance <= safeRange) {
    elements.circle.classList.add('safe-circle');
    elements.statusText.style.color = '#22c55e';
  } else if (distance <= safeRange * 1.5) {
    elements.circle.classList.add('warning-circle');
    elements.statusText.style.color = '#f59e0b';
  } else {
    elements.circle.classList.add('danger-circle');
    elements.statusText.style.color = '#ef4444';
    
    // If way too far, show warning in status
    if (distance > safeRange * 2) {
      elements.statusText.textContent = '⚠️ TOO FAR! Move closer';
    }
  }
}

function updateDirectionUI(bearing) {
  if (bearing === null) {
    elements.arrow.style.transform = 'rotate(0deg)';
    return;
  }
  
  // Rotate arrow to point toward friend
  elements.arrow.style.transform = `rotate(${bearing}deg)`;
  
  // Change arrow based on direction
  if (bearing >= -45 && bearing <= 45) {
    elements.arrow.textContent = '⬆️';
  } else if (bearing > 45 && bearing <= 135) {
    elements.arrow.textContent = '➡️';
  } else if (bearing > 135 || bearing < -135) {
    elements.arrow.textContent = '⬇️';
  } else {
    elements.arrow.textContent = '⬅️';
  }
}

// ================= CONNECTION MANAGEMENT =================
window.toggleConnection = function() {
  if (isConnected) {
    disconnect();
  } else {
    connect();
  }
};

function connect() {
  friendId = elements.pairInput.value.trim().toUpperCase();
  
  if (!friendId) {
    // If no friend ID entered, enable simulation mode with a fake friend
    friendId = 'K-SIM'; // Simulation friend ID
    simulationMode = true;
    elements.pairInput.value = friendId;
  } else {
    simulationMode = friendId === 'K-SIM';
  }
  
  if (friendId === myId && !simulationMode) {
    alert('You cannot connect to yourself');
    return;
  }
  
  if (!simulationMode && !friendId.match(/^K-\d{4}$/)) {
    alert('Please enter a valid K-ID (format: K-1234) or use K-SIM for simulation');
    return;
  }
  
  // Reset simulation state
  simulatedBaseDistance = 0;
  elements.simPosition.textContent = '0m';
  
  if (simulationMode) {
    // Start simulation mode
    startSimulationMode();
  } else {
    // Start real connection
    startGeoTracking();
    subscribeToFriend();
  }
  
  isConnected = true;
  updateUI();
  
  elements.statusText.textContent = simulationMode ? 'Starting simulation...' : 'Connecting...';
  elements.statusText.style.color = '#f59e0b';
}

function startSimulationMode() {
  // In simulation mode, we don't use real geolocation
  // Instead, we simulate two devices with a starting distance
  currentDistance = 20; // Start at 20 meters
  updateDistanceUI(currentDistance);
  
  // Simulate periodic distance changes
  simulationInterval = setInterval(() => {
    // Small random drift to simulate natural movement
    const drift = (Math.random() - 0.5) * 5;
    currentDistance = Math.max(1, currentDistance + drift);
    updateDistanceUI(currentDistance);
  }, 3000);
  
  // Update status
  setTimeout(() => {
    elements.statusText.textContent = 'Connected (Simulation Mode)';
    elements.statusText.style.color = '#8b5cf6';
  }, 1000);
}

function disconnect() {
  // Stop geolocation
  if (geoWatchId !== null) {
    navigator.geolocation.clearWatch(geoWatchId);
    geoWatchId = null;
  }
  
  // Unsubscribe from Firebase
  if (unsubscribeSnapshot) {
    unsubscribeSnapshot();
    unsubscribeSnapshot = null;
  }
  
  // Stop simulation interval
  if (simulationInterval) {
    clearInterval(simulationInterval);
    simulationInterval = null;
  }
  
  // Reset state
  isConnected = false;
  simulationMode = false;
  distanceHistory = [];
  simulatedBaseDistance = 0;
  currentDistance = 0;
  
  // Reset UI
  updateDistanceUI(null);
  updateDirectionUI(null);
  elements.statusText.textContent = 'Disconnected';
  elements.statusText.style.color = '#ef4444';
  elements.simPosition.textContent = '0m';
  
  setTimeout(() => {
    updateUI();
  }, 1000);
}

// ================= GEOLOCATION TRACKING =================
function startGeoTracking() {
  if (!navigator.geolocation) {
    alert('Geolocation is not supported by your browser');
    disconnect();
    return;
  }
  
  geoWatchId = navigator.geolocation.watchPosition(
    (position) => {
      if (!isConnected) return;
      
      const { latitude, longitude } = position.coords;
      
      // Save my location to Firebase
      const pairId = [myId, friendId].sort().join('_');
      const myLocationRef = doc(db, 'bands', pairId);
      
      setDoc(myLocationRef, {
        [myId]: {
          lat: latitude,
          lng: longitude,
          timestamp: Date.now()
        }
      }, { merge: true });
    },
    (error) => {
      console.error('Geolocation error:', error);
      alert('Please enable location permissions');
      disconnect();
    },
    {
      enableHighAccuracy: true,
      maximumAge: 10000,
      timeout: 15000
    }
  );
}

// ================= FIREBASE SUBSCRIPTION =================
function subscribeToFriend() {
  const pairId = [myId, friendId].sort().join('_');
  const pairRef = doc(db, 'bands', pairId);
  
  unsubscribeSnapshot = onSnapshot(pairRef, (snapshot) => {
    if (!isConnected || !snapshot.exists()) return;
    
    const data = snapshot.data();
    
    // Find friend's location
    const friendKey = Object.keys(data).find(key => key !== myId);
    
    if (!friendKey || !data[friendKey] || !data[myId]) {
      elements.statusText.textContent = 'Waiting for friend...';
      return;
    }
    
    // Calculate distance
    const myLocation = data[myId];
    const friendLocation = data[friendKey];
    
    const rawDistance = calculateDistance(
      myLocation.lat,
      myLocation.lng,
      friendLocation.lat,
      friendLocation.lng
    );
    
    // Smooth distance
    const smoothedDistance = smoothDistance(rawDistance);
    
    // Calculate bearing (direction)
    const bearing = calculateBearing(
      myLocation.lat,
      myLocation.lng,
      friendLocation.lat,
      friendLocation.lng
    );
    
    // Update UI
    updateDistanceUI(smoothedDistance);
    updateDirectionUI(bearing);
    
    elements.statusText.textContent = `Connected to ${friendKey}`;
    elements.statusText.style.color = '#22c55e';
    
    // Check if out of safe range
    if (smoothedDistance > safeRange) {
      elements.statusText.textContent = `⚠️ ${friendKey} is ${smoothedDistance}m away`;
      elements.statusText.style.color = '#f59e0b';
    }
  });
}

// ================= DIRECTION CALCULATION =================
function calculateBearing(lat1, lon1, lat2, lon2) {
  const φ1 = lat1 * Math.PI / 180;
  const φ2 = lat2 * Math.PI / 180;
  const Δλ = (lon2 - lon1) * Math.PI / 180;
  
  const y = Math.sin(Δλ) * Math.cos(φ2);
  const x = Math.cos(φ1) * Math.sin(φ2) -
            Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);
  
  const θ = Math.atan2(y, x);
  const bearing = (θ * 180 / Math.PI + 360) % 360;
  
  return bearing;
}

// ================= INITIALIZE APP =================
document.addEventListener('DOMContentLoaded', () => {
  initializeAppState();
  
  // Load saved friend ID if exists
  const savedFriendId = localStorage.getItem('kumbhBandFriendId');
  if (savedFriendId) {
    elements.pairInput.value = savedFriendId;
  }
  
  // Save friend ID when input changes
  elements.pairInput.addEventListener('input', () => {
    localStorage.setItem('kumbhBandFriendId', elements.pairInput.value);
  });
  
  // Request location permission on page load
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      () => console.log('Location permission granted'),
      () => console.warn('Location permission denied')
    );
  }
  
  // Add keyboard shortcuts for simulation
  document.addEventListener('keydown', (e) => {
    if (!isConnected) return;
    
    switch(e.key) {
      case 'ArrowUp':
      case 'w':
      case 'W':
        simulateDistance(-10); // Move away
        break;
      case 'ArrowDown':
      case 's':
      case 'S':
        simulateDistance(10); // Move closer
        break;
    }
  });
});

// Global variable for simulation interval
let simulationInterval = null;
</script>

</body>
</html>
