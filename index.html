<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Kumbh Band Prototype</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body {
  background: radial-gradient(circle at top, #0f172a, #020617);
  color: #e5e7eb;
  font-family: system-ui, -apple-system, sans-serif;
  text-align: center;
  padding: 20px;
  min-height: 100vh;
}

.container {
  max-width: 500px;
  margin: 0 auto;
}

h2 {
  font-weight: 700;
  font-size: 2rem;
  margin-bottom: 10px;
  color: #60a5fa;
  text-shadow: 0 2px 4px rgba(0,0,0,0.5);
}

.subtitle {
  color: #94a3b8;
  margin-bottom: 30px;
  font-size: 0.9rem;
}

/* Feature Cards */
.feature-card {
  background: rgba(30, 41, 59, 0.7);
  border-radius: 16px;
  padding: 20px;
  margin: 20px 0;
  border-left: 4px solid #22c55e;
  text-align: left;
}

.feature-card.hardware {
  border-left-color: #8b5cf6;
}

.feature-card h3 {
  color: #22c55e;
  margin-top: 0;
  display: flex;
  align-items: center;
  gap: 10px;
}

.feature-card.hardware h3 {
  color: #8b5cf6;
}

.feature-icon {
  font-size: 24px;
}

.feature-desc {
  color: #cbd5e1;
  font-size: 14px;
  line-height: 1.6;
  margin: 10px 0;
}

/* Distance Circle */
.circle-container {
  position: relative;
  width: 240px;
  height: 240px;
  margin: 20px auto;
}

.circle {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  border: 12px solid #64748b;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  position: relative;
}

.circle.green {
  border-color: #22c55e;
  box-shadow: 0 0 30px rgba(34, 197, 94, 0.3);
}

.circle.red {
  border-color: #ef4444;
  box-shadow: 0 0 30px rgba(239, 68, 68, 0.3);
  animation: pulse 1s infinite;
}

.circle.yellow {
  border-color: #f59e0b;
  box-shadow: 0 0 30px rgba(245, 158, 11, 0.3);
}

.distance {
  font-size: 48px;
  font-weight: 700;
  color: #ffffff;
}

.unit {
  font-size: 20px;
  color: #94a3b8;
  margin-top: 5px;
}

.gps-accuracy {
  position: absolute;
  bottom: -30px;
  left: 0;
  right: 0;
  font-size: 12px;
  color: #94a3b8;
}

/* Arrow Navigation */
.arrow-container {
  font-size: 60px;
  margin: 20px 0;
  height: 70px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.arrow {
  transition: transform 0.5s ease;
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
}

/* Status & Controls */
.status-panel {
  background: rgba(30, 41, 59, 0.7);
  padding: 20px;
  border-radius: 16px;
  margin: 20px 0;
}

.status-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 10px 0;
  padding: 10px;
  background: rgba(15, 23, 42, 0.5);
  border-radius: 10px;
}

.status-label {
  color: #94a3b8;
  font-size: 14px;
}

.status-value {
  color: #ffffff;
  font-weight: 600;
}

.status-value.safe {
  color: #22c55e;
}

.status-value.warning {
  color: #f59e0b;
}

.status-value.danger {
  color: #ef4444;
}

/* Safe Range Controls */
.range-controls {
  background: rgba(30, 41, 59, 0.7);
  padding: 20px;
  border-radius: 16px;
  margin: 20px 0;
}

.range-slider {
  width: 100%;
  margin: 20px 0;
  -webkit-appearance: none;
  height: 8px;
  border-radius: 4px;
  background: #475569;
  outline: none;
}

.range-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: #22c55e;
  cursor: pointer;
  border: 3px solid #ffffff;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

.range-display {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 15px;
}

.range-value {
  font-size: 24px;
  font-weight: 700;
  color: #22c55e;
}

.range-text {
  color: #94a3b8;
  font-size: 14px;
}

/* Connection Panel */
.connection-panel {
  background: rgba(30, 41, 59, 0.7);
  padding: 20px;
  border-radius: 16px;
  margin: 20px 0;
}

.kid-display {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 15px 0;
  padding: 15px;
  background: rgba(15, 23, 42, 0.5);
  border-radius: 10px;
}

.kid-label {
  color: #94a3b8;
  font-size: 14px;
}

.kid-value {
  font-size: 24px;
  font-weight: 800;
  color: #22c55e;
  font-family: monospace;
  letter-spacing: 2px;
}

.input-group {
  margin: 20px 0;
}

.input-label {
  display: block;
  color: #94a3b8;
  font-size: 14px;
  margin-bottom: 10px;
  text-align: left;
}

input {
  padding: 14px;
  border-radius: 12px;
  border: 2px solid #475569;
  width: 100%;
  background: #0f172a;
  color: #ffffff;
  font-size: 16px;
  transition: border-color 0.3s;
  box-sizing: border-box;
}

input:focus {
  outline: none;
  border-color: #60a5fa;
}

/* Buttons */
.button-section {
  margin: 30px 0;
  display: flex;
  flex-direction: column;
  gap: 15px;
}

button {
  padding: 16px 32px;
  border-radius: 25px;
  border: none;
  font-size: 18px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  letter-spacing: 1px;
  width: 100%;
}

.connect-btn {
  background: linear-gradient(135deg, #22c55e, #16a34a);
  color: white;
  box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
}

.connect-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
}

.connect-btn.connected {
  background: linear-gradient(135deg, #ef4444, #dc2626);
  box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
}

.simulate-btn {
  background: linear-gradient(135deg, #8b5cf6, #7c3aed);
  color: white;
  margin-top: 10px;
}

.simulate-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
}

/* Simulation Controls */
.simulation-controls {
  background: rgba(30, 41, 59, 0.7);
  padding: 20px;
  border-radius: 16px;
  margin: 20px 0;
}

.sim-controls-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  margin-top: 15px;
}

.sim-control-btn {
  padding: 12px;
  background: #475569;
  border: none;
  border-radius: 10px;
  color: white;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
}

.sim-control-btn:hover {
  background: #64748b;
  transform: translateY(-2px);
}

/* Footer */
.footer {
  margin-top: 40px;
  padding-top: 20px;
  border-top: 1px solid #334155;
  font-size: 12px;
  color: #64748b;
  line-height: 1.6;
}

.insight-box {
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.3);
  border-radius: 10px;
  padding: 15px;
  margin: 15px 0;
  text-align: left;
}

.insight-title {
  color: #ef4444;
  font-weight: 600;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.hardware-note {
  background: rgba(34, 197, 94, 0.1);
  border: 1px solid rgba(34, 197, 94, 0.3);
  border-radius: 10px;
  padding: 15px;
  margin: 15px 0;
  text-align: left;
}

.hardware-title {
  color: #22c55e;
  font-weight: 600;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 8px;
}

/* Animations */
@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.7; }
  100% { opacity: 1; }
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
}

.vibrate {
  animation: shake 0.5s ease-in-out;
}

/* Responsive */
@media (max-width: 480px) {
  .circle-container {
    width: 200px;
    height: 200px;
  }
  
  .distance {
    font-size: 40px;
  }
  
  .sim-controls-grid {
    grid-template-columns: 1fr;
  }
}
</style>
</head>

<body>

<div class="container">
  <h2>KUMBH BAND PROTOTYPE</h2>
  <div class="subtitle">Testing GPS-based distance tracking (For demo only)</div>

  <!-- Feature Explanation -->
  <div class="feature-card">
    <h3><span class="feature-icon">üì°</span> PROTOTYPE PURPOSE</h3>
    <div class="feature-desc">
      This web prototype uses GPS to demonstrate distance tracking logic. 
      It intentionally shows GPS limitations (fluctuations, inaccuracies) 
      to validate why Bluetooth is better for the actual hardware.
    </div>
  </div>

  <!-- 1. DISTANCE METER -->
  <div class="feature-card">
    <h3><span class="feature-icon">üìè</span> 1. DISTANCE METER</h3>
    <div class="feature-desc">
      Shows real-time distance between connected users using GPS coordinates.
      <strong>Observe the fluctuations</strong> - this demonstrates why GPS isn't ideal for the hardware.
    </div>
  </div>

  <div class="circle-container">
    <div class="circle" id="circle">
      <div class="distance" id="distance">--</div>
      <div class="unit">meters</div>
    </div>
    <div class="gps-accuracy" id="gpsAccuracy">GPS accuracy: --</div>
  </div>

  <!-- 2. NAVIGATION ARROW -->
  <div class="feature-card">
    <h3><span class="feature-icon">üß≠</span> 2. DIRECTION INDICATOR</h3>
    <div class="feature-desc">
      Arrow points toward the other user. Uses compass + GPS bearing.
      <strong>Note the instability</strong> - hardware will use simpler LED guidance.
    </div>
  </div>

  <div class="arrow-container">
    <div class="arrow" id="arrow">‚¨ÜÔ∏è</div>
  </div>

  <!-- Status Panel -->
  <div class="status-panel">
    <div class="status-item">
      <span class="status-label">Connection Status</span>
      <span class="status-value" id="statusText">Disconnected</span>
    </div>
    <div class="status-item">
      <span class="status-label">Safe Range Status</span>
      <span class="status-value safe" id="rangeStatus">IN RANGE</span>
    </div>
    <div class="status-item">
      <span class="status-label">GPS Updates</span>
      <span class="status-value" id="gpsUpdates">0</span>
    </div>
  </div>

  <!-- 3. SAFE RANGE CONTROL -->
  <div class="feature-card">
    <h3><span class="feature-icon">üõ°Ô∏è</span> 3. SAFE RANGE</h3>
    <div class="feature-desc">
      Defines maximum allowed separation distance. When exceeded, visual alerts activate.
      Hardware will add vibration alerts.
    </div>
  </div>

  <div class="range-controls">
    <div class="range-text">Adjust safe distance threshold:</div>
    <input type="range" min="10" max="100" value="50" class="range-slider" id="rangeSlider" oninput="updateRange(this.value)">
    <div class="range-display">
      <span class="range-text">Safe Range:</span>
      <span class="range-value" id="rangeValue">50</span>
      <span class="range-text">meters</span>
    </div>
  </div>

  <!-- 4. CONNECTION LOGIC -->
  <div class="feature-card">
    <h3><span class="feature-icon">üîó</span> 4. CONNECTION SYSTEM</h3>
    <div class="feature-desc">
      Each user gets a unique K-ID. Enter friend's K-ID to connect.
      Hardware bands will auto-connect via Bluetooth.
    </div>
  </div>

  <div class="connection-panel">
    <div class="kid-display">
      <span class="kid-label">YOUR K-ID</span>
      <span class="kid-value" id="myKid">K-0000</span>
    </div>
    
    <div class="input-group">
      <label class="input-label">ENTER FRIEND'S K-ID:</label>
      <input type="text" id="friendKid" placeholder="e.g., K-1234" maxlength="6">
    </div>
    
    <div class="button-section">
      <button class="connect-btn" id="connectBtn" onclick="toggleConnection()">CONNECT</button>
      <button class="simulate-btn" onclick="startSimulation()">START SIMULATION MODE</button>
    </div>
  </div>

  <!-- Simulation Controls -->
  <div class="simulation-controls">
    <div class="feature-desc">
      <strong>Test distance changes:</strong> Simulate moving closer or farther apart.
      Use this to see how the system responds to distance changes.
    </div>
    
    <div class="sim-controls-grid">
      <button class="sim-control-btn" onclick="simulateDistance(-5)">Move 5m Closer</button>
      <button class="sim-control-btn" onclick="simulateDistance(5)">Move 5m Away</button>
      <button class="sim-control-btn" onclick="simulateDistance(-20)">Move 20m Closer</button>
      <button class="sim-control-btn" onclick="simulateDistance(20)">Move 20m Away</button>
    </div>
    
    <div class="status-item" style="margin-top: 15px;">
      <span class="status-label">Simulated Adjustment</span>
      <span class="status-value" id="simAdjustment">0m</span>
    </div>
  </div>

  <!-- Hardware vs Prototype Insights -->
  <div class="insight-box">
    <div class="insight-title">‚ö†Ô∏è GPS LIMITATIONS OBSERVED</div>
    <div class="feature-desc">
      <strong>This prototype shows why we're NOT using GPS in hardware:</strong><br>
      ‚Ä¢ Distance fluctuates even when devices are stationary<br>
      ‚Ä¢ Poor accuracy indoors/urban areas<br>
      ‚Ä¢ High battery consumption<br>
      ‚Ä¢ Requires internet connection<br>
      <br>
      <strong>Hardware solution:</strong> Bluetooth LE for stable, low-power proximity detection.
    </div>
  </div>

  <div class="hardware-note">
    <div class="hardware-title">‚úÖ HARDWARE ADVANTAGES</div>
    <div class="feature-desc">
      <strong>The actual Kumbh Band will:</strong><br>
      ‚Ä¢ Use Bluetooth LE (stable, low power)<br>
      ‚Ä¢ Have simple LED indicators (no complex arrows)<br>
      ‚Ä¢ Include vibration alerts<br>
      ‚Ä¢ Auto-connect without manual pairing<br>
      ‚Ä¢ Work without internet or GPS<br>
      ‚Ä¢ Last 7+ days on single charge
    </div>
  </div>

  <div class="footer">
    <strong>Prototype Goals Achieved:</strong><br>
    1. ‚úì Validated distance calculation logic<br>
    2. ‚úì Demonstrated real-time tracking concepts<br>
    3. ‚úì Identified GPS limitations for dense crowds<br>
    4. ‚úì Established need for Bluetooth-based hardware<br>
    5. ‚úì Tested user feedback mechanisms<br>
    <br>
    <em>This prototype served its purpose - proving what NOT to build.</em>
  </div>
</div>

<script type="module">
// ================= FIREBASE CONFIGURATION =================
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDVV1zZZDAnqOkmNXKW0ipJXatUYtjV4W4",
  authDomain: "kumbh-band-dd624.firebaseapp.com",
  projectId: "kumbh-band-dd624",
  storageBucket: "kumbh-band-dd624.appspot.com",
  messagingSenderId: "153944613096",
  appId: "1:153944613096:web:0c5fe544c93803c2c01902"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ================= GLOBAL STATE =================
let safeRange = 50;
let isConnected = false;
let isSimulationMode = false;
let geoWatchId = null;
let unsubscribeSnapshot = null;
let myId = null;
let friendId = null;
let distanceHistory = [];
let gpsUpdateCount = 0;
let simulatedAdjustment = 0;
let lastDistance = 0;

// ================= DOM ELEMENTS =================
const elements = {
  distance: document.getElementById('distance'),
  circle: document.getElementById('circle'),
  statusText: document.getElementById('statusText'),
  arrow: document.getElementById('arrow'),
  myKid: document.getElementById('myKid'),
  friendKid: document.getElementById('friendKid'),
  rangeValue: document.getElementById('rangeValue'),
  rangeSlider: document.getElementById('rangeSlider'),
  connectBtn: document.getElementById('connectBtn'),
  rangeStatus: document.getElementById('rangeStatus'),
  gpsAccuracy: document.getElementById('gpsAccuracy'),
  gpsUpdates: document.getElementById('gpsUpdates'),
  simAdjustment: document.getElementById('simAdjustment')
};

// ================= INITIALIZATION =================
function initializeAppState() {
  // Generate or load K-ID
  myId = localStorage.getItem('kumbhBandKid');
  if (!myId) {
    myId = 'K-' + Math.floor(1000 + Math.random() * 9000);
    localStorage.setItem('kumbhBandKid', myId);
  }
  
  // Display K-ID
  elements.myKid.textContent = myId;
  
  // Load saved safe range
  const savedRange = localStorage.getItem('kumbhBandSafeRange');
  if (savedRange) {
    safeRange = parseInt(savedRange);
    elements.rangeValue.textContent = safeRange;
    elements.rangeSlider.value = safeRange;
  }
  
  // Load saved friend ID
  const savedFriendId = localStorage.getItem('kumbhBandFriendId');
  if (savedFriendId) {
    elements.friendKid.value = savedFriendId;
  }
}

// ================= SAFE RANGE CONTROL =================
function updateRange(value) {
  safeRange = parseInt(value);
  elements.rangeValue.textContent = safeRange;
  localStorage.setItem('kumbhBandSafeRange', safeRange.toString());
  
  // Update UI based on current distance
  if (lastDistance > 0) {
    updateSafetyStatus(lastDistance);
  }
}

// ================= SIMULATION CONTROLS =================
window.simulateDistance = function(change) {
  if (!isConnected) {
    alert('Please connect first to simulate movement');
    return;
  }
  
  simulatedAdjustment += change;
  elements.simAdjustment.textContent = simulatedAdjustment + 'm';
  
  if (isSimulationMode) {
    // In simulation mode, directly adjust the displayed distance
    const newDistance = Math.max(1, lastDistance + change);
    updateDistanceDisplay(newDistance);
  } else {
    // In real mode, simulate by adjusting GPS coordinates
    simulateGPSTracking(change);
  }
};

// ================= CONNECTION MANAGEMENT =================
window.toggleConnection = function() {
  if (isConnected) {
    disconnect();
  } else {
    connect();
  }
};

window.startSimulation = function() {
  if (isConnected) {
    disconnect();
  }
  
  // Set simulation mode
  isSimulationMode = true;
  friendId = 'K-SIM';
  elements.friendKid.value = friendId;
  
  // Start simulation
  connect();
};

function connect() {
  friendId = elements.friendKid.value.trim().toUpperCase();
  
  if (!friendId) {
    alert('Please enter a friend K-ID or use Simulation Mode');
    return;
  }
  
  if (friendId === myId) {
    alert('You cannot connect to yourself');
    return;
  }
  
  // Validate K-ID format (K-1234 or K-SIM)
  if (!friendId.match(/^K-(SIM|\d{4})$/)) {
    alert('Please enter a valid K-ID (format: K-1234) or use K-SIM for simulation');
    return;
  }
  
  // Check if simulation mode
  isSimulationMode = friendId === 'K-SIM';
  
  if (isSimulationMode) {
    startSimulationMode();
  } else {
    startRealConnection();
  }
  
  // Update UI
  updateConnectionUI();
}

function startSimulationMode() {
  // Simulation mode - no real GPS, just simulated data
  elements.statusText.textContent = 'Connected (Simulation)';
  elements.statusText.className = 'status-value';
  
  // Start with random distance
  lastDistance = 20 + Math.random() * 30;
  updateDistanceDisplay(lastDistance);
  
  // Simulate GPS fluctuations
  simulationInterval = setInterval(() => {
    // Add random GPS fluctuation
    const fluctuation = (Math.random() - 0.5) * 10;
    const newDistance = Math.max(1, lastDistance + fluctuation);
    updateDistanceDisplay(newDistance);
    
    // Update GPS accuracy display
    elements.gpsAccuracy.textContent = `GPS accuracy: ¬±${(5 + Math.random() * 10).toFixed(1)}m`;
    gpsUpdateCount++;
    elements.gpsUpdates.textContent = gpsUpdateCount;
  }, 2000);
  
  // Simulate arrow movement
  directionInterval = setInterval(() => {
    const randomBearing = Math.random() * 360;
    elements.arrow.style.transform = `rotate(${randomBearing}deg)`;
  }, 3000);
}

function startRealConnection() {
  // Real connection mode - use actual GPS
  if (!navigator.geolocation) {
    alert('Geolocation is not supported by your browser');
    return;
  }
  
  elements.statusText.textContent = 'Getting location...';
  
  // Start watching position
  geoWatchId = navigator.geolocation.watchPosition(
    handlePositionUpdate,
    handlePositionError,
    {
      enableHighAccuracy: true,
      maximumAge: 10000,
      timeout: 15000
    }
  );
  
  // Subscribe to friend's location
  subscribeToFriend();
}

function handlePositionUpdate(position) {
  if (!isConnected) return;
  
  const { latitude, longitude, accuracy } = position.coords;
  
  // Update GPS stats
  elements.gpsAccuracy.textContent = `GPS accuracy: ¬±${Math.round(accuracy)}m`;
  gpsUpdateCount++;
  elements.gpsUpdates.textContent = gpsUpdateCount;
  
  // Save location to Firebase
  const pairId = [myId, friendId].sort().join('_');
  const locationRef = doc(db, 'bands', pairId);
  
  setDoc(locationRef, {
    [myId]: {
      lat: latitude,
      lng: longitude,
      accuracy: accuracy,
      timestamp: Date.now()
    }
  }, { merge: true });
}

function handlePositionError(error) {
  console.error('Geolocation error:', error);
  elements.statusText.textContent = 'Location error';
  elements.statusText.className = 'status-value danger';
}

function subscribeToFriend() {
  const pairId = [myId, friendId].sort().join('_');
  const pairRef = doc(db, 'bands', pairId);
  
  unsubscribeSnapshot = onSnapshot(pairRef, (snapshot) => {
    if (!isConnected || !snapshot.exists()) return;
    
    const data = snapshot.data();
    
    // Find friend's location
    const friendKey = Object.keys(data).find(key => key !== myId);
    
    if (!friendKey || !data[friendKey] || !data[myId]) {
      elements.statusText.textContent = 'Waiting for friend...';
      return;
    }
    
    elements.statusText.textContent = `Connected to ${friendKey}`;
    elements.statusText.className = 'status-value safe';
    
    // Calculate distance
    const myLocation = data[myId];
    const friendLocation = data[friendKey];
    
    const distance = calculateDistance(
      myLocation.lat,
      myLocation.lng,
      friendLocation.lat,
      friendLocation.lng
    );
    
    // Add simulated adjustment if any
    const adjustedDistance = Math.max(1, distance + simulatedAdjustment);
    
    // Smooth the distance
    const smoothedDistance = smoothDistance(adjustedDistance);
    
    // Update display
    updateDistanceDisplay(smoothedDistance);
    
    // Calculate and update direction
    if (isSimulationMode) {
      // Random bearing for simulation
      const bearing = Math.random() * 360;
      elements.arrow.style.transform = `rotate(${bearing}deg)`;
    } else {
      const bearing = calculateBearing(
        myLocation.lat,
        myLocation.lng,
        friendLocation.lat,
        friendLocation.lng
      );
      elements.arrow.style.transform = `rotate(${bearing}deg)`;
    }
  });
}

function disconnect() {
  // Stop geolocation
  if (geoWatchId !== null) {
    navigator.geolocation.clearWatch(geoWatchId);
    geoWatchId = null;
  }
  
  // Unsubscribe from Firebase
  if (unsubscribeSnapshot) {
    unsubscribeSnapshot();
    unsubscribeSnapshot = null;
  }
  
  // Stop simulation intervals
  if (simulationInterval) {
    clearInterval(simulationInterval);
    simulationInterval = null;
  }
  
  if (directionInterval) {
    clearInterval(directionInterval);
    directionInterval = null;
  }
  
  // Reset state
  isConnected = false;
  isSimulationMode = false;
  distanceHistory = [];
  gpsUpdateCount = 0;
  simulatedAdjustment = 0;
  lastDistance = 0;
  
  // Reset UI
  elements.distance.textContent = '--';
  elements.circle.className = 'circle';
  elements.statusText.textContent = 'Disconnected';
  elements.statusText.className = 'status-value';
  elements.rangeStatus.textContent = 'IN RANGE';
  elements.rangeStatus.className = 'status-value safe';
  elements.gpsAccuracy.textContent = 'GPS accuracy: --';
  elements.gpsUpdates.textContent = '0';
  elements.simAdjustment.textContent = '0m';
  elements.arrow.style.transform = 'rotate(0deg)';
  
  updateConnectionUI();
}

// ================= DISTANCE CALCULATION =================
function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3; // Earth's radius in meters
  const œÜ1 = lat1 * Math.PI / 180;
  const œÜ2 = lat2 * Math.PI / 180;
  const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
  const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

  const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
            Math.cos(œÜ1) * Math.cos(œÜ2) *
            Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
  
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

function smoothDistance(distance) {
  distanceHistory.push(distance);
  if (distanceHistory.length > 5) {
    distanceHistory.shift();
  }
  
  const sum = distanceHistory.reduce((a, b) => a + b, 0);
  return Math.round(sum / distanceHistory.length);
}

function calculateBearing(lat1, lon1, lat2, lon2) {
  const œÜ1 = lat1 * Math.PI / 180;
  const œÜ2 = lat2 * Math.PI / 180;
  const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
  
  const y = Math.sin(ŒîŒª) * Math.cos(œÜ2);
  const x = Math.cos(œÜ1) * Math.sin(œÜ2) -
            Math.sin(œÜ1) * Math.cos(œÜ2) * Math.cos(ŒîŒª);
  
  const Œ∏ = Math.atan2(y, x);
  return (Œ∏ * 180 / Math.PI + 360) % 360;
}

// ================= UI UPDATES =================
function updateConnectionUI() {
  if (isConnected) {
    elements.connectBtn.textContent = 'DISCONNECT';
    elements.connectBtn.classList.add('connected');
  } else {
    elements.connectBtn.textContent = 'CONNECT';
    elements.connectBtn.classList.remove('connected');
  }
}

function updateDistanceDisplay(distance) {
  lastDistance = distance;
  
  // Update distance number with animation
  elements.distance.textContent = Math.round(distance);
  elements.distance.style.transform = 'scale(1.1)';
  setTimeout(() => {
    elements.distance.style.transform = 'scale(1)';
  }, 200);
  
  // Update safety status
  updateSafetyStatus(distance);
}

function updateSafetyStatus(distance) {
  // Update circle color and status
  if (distance <= safeRange) {
    elements.circle.className = 'circle green';
    elements.rangeStatus.textContent = 'IN RANGE';
    elements.rangeStatus.className = 'status-value safe';
  } else if (distance <= safeRange * 1.5) {
    elements.circle.className = 'circle yellow';
    elements.rangeStatus.textContent = 'WARNING';
    elements.rangeStatus.className = 'status-value warning';
    
    // Add vibration simulation
    if (navigator.vibrate) {
      navigator.vibrate(200);
    }
  } else {
    elements.circle.className = 'circle red';
    elements.rangeStatus.textContent = 'OUT OF RANGE';
    elements.rangeStatus.className = 'status-value danger';
    
    // Add stronger vibration simulation
    if (navigator.vibrate) {
      navigator.vibrate([100, 50, 100, 50, 100]);
    }
    
    // Shake animation
    elements.circle.classList.add('vibrate');
    setTimeout(() => {
      elements.circle.classList.remove('vibrate');
    }, 500);
  }
}

// ================= SIMULATE GPS TRACKING =================
function simulateGPSTracking(change) {
  // This would adjust the actual GPS coordinates in Firebase
  // For now, just update the display
  if (lastDistance > 0) {
    const newDistance = Math.max(1, lastDistance + change);
    updateDistanceDisplay(newDistance);
  }
}

// ================= INITIALIZE =================
document.addEventListener('DOMContentLoaded', () => {
  initializeAppState();
  
  // Save friend ID when changed
  elements.friendKid.addEventListener('input', () => {
    localStorage.setItem('kumbhBandFriendId', elements.friendKid.value);
  });
  
  // Request location permission
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      () => console.log('Location permission granted'),
      () => console.warn('Location permission denied or not available')
    );
  }
  
  // Keyboard shortcuts for simulation
  document.addEventListener('keydown', (e) => {
    if (!isConnected) return;
    
    switch(e.key) {
      case 'ArrowUp':
      case 'w':
        simulateDistance(5);
        break;
      case 'ArrowDown':
      case 's':
        simulateDistance(-5);
        break;
    }
  });
});

// Global intervals
let simulationInterval = null;
let directionInterval = null;
</script>

</body>
</html>
