<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Kumbh Band Prototype</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body {
  background: radial-gradient(circle at top, #0f172a, #020617);
  color: #e5e7eb;
  font-family: system-ui, -apple-system;
  text-align: center;
  padding: 24px;
}

h2 {
  font-weight: 600;
  letter-spacing: 1px;
}

.circle {
  width: 240px;
  height: 240px;
  border-radius: 50%;
  border: 10px solid #64748b;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 42px;
  margin: 24px auto;
  box-shadow: 0 0 40px rgba(34,197,94,0.25);
  transition: all 0.3s ease;
}

#status {
  font-size: 15px;
  margin-bottom: 16px;
  letter-spacing: 1px;
}

input {
  padding: 12px;
  font-size: 16px;
  border-radius: 12px;
  border: none;
  width: 220px;
  outline: none;
}

button {
  padding: 10px 18px;
  font-size: 16px;
  border-radius: 14px;
  border: none;
  margin: 6px;
  background: #22c55e;
  color: #022c22;
  cursor: pointer;
}

button:active { transform: scale(0.96); }

.kid-box {
  font-size: 26px;
  font-weight: bold;
  margin: 8px 0;
  letter-spacing: 2px;
}

.arrow {
  font-size: 46px;
  margin-top: 10px;
  transition: transform 0.4s ease;
}
</style>
</head>

<body>

<h2>Kumbh Band</h2>

<div class="circle" id="circle">
  <span id="distance">--</span> m
</div>

<div id="status">Not connected</div>
<div class="arrow" id="arrow">⬆️</div>

<div>Your K-ID</div>
<div class="kid-box" id="myId"></div>

<br>
<input id="pairInput" placeholder="Enter Friend K-ID" />
<br><br>

<div>
  <div>Safe Range</div>
  <div style="font-size:24px;font-weight:bold">
    <span id="safeValue">50</span> m
  </div>
  <button onclick="changeRange(-10)">−</button>
  <button onclick="changeRange(10)">+</button>
</div>

<br>
<button onclick="connect()">Connect</button>

<script type="module">
/* ================= FIREBASE ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "PASTE_API_KEY",
  authDomain: "PASTE_AUTH_DOMAIN",
  projectId: "PASTE_PROJECT_ID",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ================= UTILS ================= */
function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3;
  const φ1 = lat1 * Math.PI / 180;
  const φ2 = lat2 * Math.PI / 180;
  const Δφ = (lat2 - lat1) * Math.PI / 180;
  const Δλ = (lon2 - lon1) * Math.PI / 180;

  const a = Math.sin(Δφ/2)**2 +
            Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;

  return Math.round(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
}

function getBearing(lat1, lon1, lat2, lon2) {
  const φ1 = lat1 * Math.PI / 180;
  const φ2 = lat2 * Math.PI / 180;
  const Δλ = (lon2 - lon1) * Math.PI / 180;
  const y = Math.sin(Δλ) * Math.cos(φ2);
  const x = Math.cos(φ1) * Math.sin(φ2) -
            Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);
  return (Math.atan2(y,x)*180/Math.PI+360)%360;
}

/* ================= STATE ================= */
let safeRange = 50;
document.getElementById("safeValue").innerText = safeRange;

window.changeRange = (v) => {
  safeRange = Math.max(10, safeRange + v);
  document.getElementById("safeValue").innerText = safeRange;
};

/* ================= K-ID ================= */
let myId = localStorage.getItem("kid");
if (!myId) {
  myId = "K-" + Math.floor(1000 + Math.random()*9000);
  localStorage.setItem("kid", myId);
}
document.getElementById("myId").innerText = myId;

/* ================= CONNECT ================= */
let pairRef = null;

window.connect = () => {
  const friendId = document.getElementById("pairInput").value.trim();
  if (!friendId) return alert("Enter Friend K-ID");

  const pairId = [myId, friendId].sort().join("_");
  pairRef = doc(db, "pairs", pairId);

  navigator.geolocation.watchPosition(
    (pos) => {
      setDoc(pairRef, {
        [myId]: {
          lat: pos.coords.latitude,
          lng: pos.coords.longitude
        }
      }, { merge: true });
    },
    () => alert("Location permission required"),
    { enableHighAccuracy: true }
  );

  onSnapshot(pairRef, (snap) => {
    const data = snap.data();
    if (!data || !data[myId]) return;

    const otherId = Object.keys(data).find(u => u !== myId);
    if (!otherId) {
      status.innerText = "Waiting for friend…";
      return;
    }

    const dist = getDistance(
      data[myId].lat, data[myId].lng,
      data[otherId].lat, data[otherId].lng
    );

    const bearing = getBearing(
      data[myId].lat, data[myId].lng,
      data[otherId].lat, data[otherId].lng
    );

    document.getElementById("distance").innerText = dist;
    document.getElementById("arrow").style.transform = `rotate(${bearing}deg)`;

    if (dist <= safeRange) {
      circle.style.borderColor = "#22c55e";
      status.innerText = "SAFE";
      status.style.color = "#22c55e";
    } else {
      circle.style.borderColor = "#ef4444";
      status.innerText = "OUT OF RANGE";
      status.style.color = "#ef4444";
      navigator.vibrate?.([200,100,200]);
    }
  });

  status.innerText = "Connected";
};
</script>
</body>
</html>
