<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Kumbh Band Prototype</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body {
  background: radial-gradient(circle at top, #0f172a, #020617);
  color: #e5e7eb;
  font-family: system-ui, -apple-system;
  text-align: center;
  padding: 24px;
}

h2 { font-weight: 600; }

.circle {
  width: 240px;
  height: 240px;
  border-radius: 50%;
  border: 10px solid #64748b;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 42px;
  margin: 24px auto;
  transition: border-color 0.3s ease;
}

#status {
  font-size: 14px;
  letter-spacing: 1px;
  margin-bottom: 12px;
}

.arrow {
  font-size: 50px;
  transition: transform 0.3s ease-out;
}

input {
  padding: 12px;
  border-radius: 12px;
  border: none;
  width: 220px;
}

button {
  padding: 10px 18px;
  border-radius: 14px;
  border: none;
  margin: 6px;
  background: #22c55e;
  color: #022c22;
  cursor: pointer;
}

button.disconnect {
  background: #ef4444;
  color: white;
}

.kid-box {
  font-size: 26px;
  font-weight: bold;
  margin: 6px;
}
</style>
</head>

<body>

<h2>Kumbh Band</h2>

<div class="circle" id="circle">
  <span id="distance">--</span> m
</div>

<div id="status">Not connected</div>
<div class="arrow" id="arrow">⬆️</div>

<div>Your K-ID</div>
<div class="kid-box" id="myId"></div>

<input id="pairInput" placeholder="Enter Friend K-ID" />
<br><br>

<div>
  Safe Range: <span id="safeValue">50</span> m <br>
  <button onclick="changeRange(-10)">−</button>
  <button onclick="changeRange(10)">+</button>
</div>

<br>
<button id="connectBtn" onclick="toggleConnection()">Connect</button>

<script type="module">
/* ================= FIREBASE ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDVV1zZZDAnqOkmNXKW0ipJXatUYtjV4W4",
  authDomain: "kumbh-band-dd624.firebaseapp.com",
  projectId: "kumbh-band-dd624",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ================= STATE ================= */
let safeRange = 50;
let isConnected = false;
let geoWatchId = null;
let unsubscribeSnapshot = null;

document.getElementById("safeValue").innerText = safeRange;

window.changeRange = (v) => {
  safeRange = Math.max(10, safeRange + v);
  document.getElementById("safeValue").innerText = safeRange;
};

/* ================= K-ID ================= */
let myId = localStorage.getItem("kid");
if (!myId) {
  myId = "K-" + Math.floor(1000 + Math.random() * 9000);
  localStorage.setItem("kid", myId);
}
myIdEl.innerText = myId;

/* ================= UTILS ================= */
function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3;
  const φ1 = lat1 * Math.PI / 180;
  const φ2 = lat2 * Math.PI / 180;
  const Δφ = (lat2 - lat1) * Math.PI / 180;
  const Δλ = (lon2 - lon1) * Math.PI / 180;

  const a = Math.sin(Δφ/2)**2 +
            Math.cos(φ1)*Math.cos(φ2)*
            Math.sin(Δλ/2)**2;

  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

/* ================= SMOOTHING ================= */
let distanceHistory = [];
function smoothDistance(d) {
  if (d > 500) return null;
  distanceHistory.push(d);
  if (distanceHistory.length > 5) distanceHistory.shift();
  return Math.round(distanceHistory.reduce((a,b)=>a+b)/distanceHistory.length);
}

/* ================= CONNECT / DISCONNECT ================= */
let pairRef = null;

window.toggleConnection = () => {
  isConnected ? disconnect() : connect();
};

function connect() {
  const friendId = pairInput.value.trim();
  if (!friendId) return alert("Enter Friend K-ID");

  const pairId = [myId, friendId].sort().join("_");
  pairRef = doc(db, "bands", pairId);

  geoWatchId = navigator.geolocation.watchPosition(
    (pos) => {
      if (pos.coords.accuracy > 30) return;
      setDoc(pairRef, {
        [myId]: { lat: pos.coords.latitude, lng: pos.coords.longitude }
      }, { merge: true });
    }
  );

  unsubscribeSnapshot = onSnapshot(pairRef, (snap) => {
    const data = snap.data();
    if (!data) return;

    const otherId = Object.keys(data).find(id => id !== myId);
    if (!otherId) {
      status.innerText = "Waiting for other band…";
      return;
    }

    status.innerText = "Connected";
    status.style.color = "#22c55e";

    const rawDist = getDistance(
      data[myId].lat, data[myId].lng,
      data[otherId].lat, data[otherId].lng
    );

    const dist = smoothDistance(rawDist);
    if (dist === null) return;

    distance.innerText = dist;

    circle.style.borderColor =
      dist <= safeRange ? "#22c55e" : "#ef4444";
  });

  isConnected = true;
  connectBtn.innerText = "Disconnect";
  connectBtn.classList.add("disconnect");
}

function disconnect() {
  if (geoWatchId !== null) navigator.geolocation.clearWatch(geoWatchId);
  if (unsubscribeSnapshot) unsubscribeSnapshot();

  geoWatchId = null;
  unsubscribeSnapshot = null;
  isConnected = false;
  distanceHistory = [];

  distance.innerText = "--";
  arrow.style.transform = "rotate(0deg)";
  status.innerText = "Not connected";
  status.style.color = "#e5e7eb";
  circle.style.borderColor = "#64748b";

  connectBtn.innerText = "Connect";
  connectBtn.classList.remove("disconnect");
}
</script>

</body>
</html>
